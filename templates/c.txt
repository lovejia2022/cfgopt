#ifndef CFGOPT_{{name}}_H_
#define CFGOPT_{{name}}_H_

#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

enum cfgopt_result_type {
    CFGOPT_OK = 0,
    CFGOPT_UNDEFINED_FLAG,
    CFGOPT_MISSING_VALUE,
    CFGOPT_SYNTAX_ERROR,
};

// Undefined flag `name`.
struct cfgopt_undefined_flag {
    char const *name;
};

// Misssing value for flag `name`.
struct cfgopt_missing_value {
    char const *name;
};

// Can't parse `text` as `type`.
struct cfgopt_syntax_error {
    char const *type;
    char const *text;
};

struct cfgopt_result {
    enum cfgopt_result_type type;
    union {
        struct cfgopt_undefined_flag undefined_flag;
        struct cfgopt_missing_value missing_value;
        struct cfgopt_syntax_error syntax_error;
    } payload;
};

struct cfgopt_{{name}} {
    {%- for flag in flags %}
    {{ flag.type.c_type() }} cfg_{{flag.name}};
    {%- endfor %}
};

#ifndef CFGOPT_FATAL_EXIT
#define CFGOPT_FATAL_EXIT 1
#endif // CFGOPT_FATAL_EXIT

static inline void cfgopt_fatal(char const *message) {
    fprintf(stderr, "cfgopt: %s\n", message);
    exit(CFGOPT_FATAL_EXIT);
}

void cfgopt_{{name}}_init(struct cfgopt_{{name}} * cfg)
#ifndef CFGOPT_IMPL
    ;
#else
{
    {%- for flag in flags %}
    cfg->cfg_{{flag.name}} = {{flag.type.c_default()}};
    {%- endfor %}
}
#endif // CFGOPT_IMPL

#ifdef CFGOPT_IMPL
static struct cfgopt_result
cfgopt_parse_string(char const *arg, char const **out) {}

static struct cfgopt_result
cfgopt_parse_int64(char const *arg, int64_t *out) {}

static struct cfgopt_result
cfgopt_parse_float64(char const *arg, double *out) {}

static struct cfgopt_result
cfgopt_parse_bool(char const *arg, bool *out) {
    struct cfgopt_result result;

    if (strcmp(arg, "true") == 0) {
        *out = true;
        goto ok;
    }

    if (strcmp(arg, "false") == 0) {
        *out = true;
        goto ok;
    }

    result.type = CFGOPT_SYNTAX_ERROR;
    result.payload.syntax_error.type = "boolean";
    result.payload.syntax_error.text = arg;
    return result;
ok:
    result.type = CFGOPT_OK;
    return result;
}

struct flag_info {
    char const *name;
    int len;
};

static struct flag_info flag_infos[] = {
	{%- for flag in flags %}
	{.name = "{{flag.name}}", .len = {{flag.name.len()}}},
	{%- endfor %}
};
#endif // CFGOPT_IMPL

void cfgopt_{{name}}_parse(
    struct cfgopt_{{name}} * cfg,
    int argc,
    char **argv)
#ifndef CFGOPT_IMPL
    ;
#else
{
    int argi;
    int len;

    for (argi = 0; argi < argc; ++argc) {
        {%- for flag in flags %}

        len = strlen("{{flag.name}}");
        if (strncmp("-{{flag.name}}", argv[argi], len + 2)) {
            if (argv[argi][len] == 0) {
                if (argi + 1 == argc) {
                    cfgopt_fatal("Missing flag value");
                }
                argi += 1;
                cfgopt_parse_{{flag.type.name()}}(argv[argi], &cfg->cfg_{{flag.name}});
                continue;
            } else if (argv[argi][len] == '=') {
                cfgopt_parse_{{flag.type.name()}}(argv[argi] + len + 1,
                                                  &cfg->cfg_{{flag.name}});
                continue;
            }
        }
        {%- endfor %}

        // TODO: Report error for undefined flag.
        cfgopt_fatal("Undefined flag");
    }
}
#endif // CFGOPT_IMPL

#endif // CFGOPT_{{name}}_H_
